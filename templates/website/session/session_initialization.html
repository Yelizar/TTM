{% extends "website/base.html" %}
{% block titel %} Session initialization {% endblock %}
{% block content %}
    {#  logic of the process will be rebuild after a discussion #}
    <h5>Session Initialization</h5>
    <div id="student_details" style="float: left; width: 50%; height: 500px">
        <table>
            <tr>
                <td>
                    <label id="id_student_name">Student: {{ object.get_full_name }}</label>
                </td>
            </tr>
            <tr>
                <td>
                    <label id="id_student_language">Language: {{ object.studentdetails.languages }}</label>
                </td>
            </tr>
            <tr>
                <td><label id="id_student_method">Method: </label></td>
                {% for method in object.studentdetails.communication_methods.all %}
                    <td><input type="radio" id="communication_method_{{ method }}" name="communication_method"
                               class="method"
                               value="{{ method }}">{{ method }}</td>
                {% endfor %}
            </tr>
        </table>
    </div>
    <div id="tutor_details" style="float: left; width: 50%; height: 500px">
        <table>
            {% if list_tutors %}
                {% for tutor in list_tutors.tutor.all %}
                    {% if tutor != request.user %}
                        <tr>
                            <td>
                                <label id="id_student_language">Tutor: {{ tutor.get_full_name }}</label>
                            </td>
                        </tr>
                    {% endif %}
                {% endfor %}
            {% endif %}
        </table>
    </div>


    <table id="tutor_list">
    </table>
    <input type="button" value="REDIRECT" id="confirm_student">
    <script>

        var sessionName = {{ session_name_json }};
        var wsProtocol = 'ws://';
        if (window.location.protocol === 'https:') {
            wsProtocol = 'wss://'
        }
        var sessionSocket = new WebSocket(
            wsProtocol + window.location.host +
            '/ws/session-initialization/' + sessionName + '/');

        sessionSocket.onopen = function (e) {
            console.log(e.data)
        };

        sessionSocket.onmessage = function (e) {
            console.log(sessionSocket);
            var data = JSON.parse(e.data);
            if (data['add_user']) {
                var addedUser = data['add_user'];
                var td = document.createElement('td');
                var tr = document.createElement('tr');
                var lable = document.createElement('label');
                var button = document.createElement('input');
                tr.setAttribute('id', addedUser.username);
                tr.setAttribute('class', 'tr_tutor_obj');
                button.setAttribute('value', 'Choose tutor');
                button.setAttribute('type', 'button');
                button.setAttribute('id', 'choice');
                lable.innerHTML = "Tutor: " + addedUser.first_name + ' ' + addedUser.last_name;
                td.appendChild(lable);
                td.appendChild(button);
                tr.appendChild(td);
                document.querySelector('#tutor_details').appendChild(tr);
            } else if (data['remove_user']) {

                var removedUser = data['remove_user'];
                $('#'+removedUser['username']).remove()
            }
            else if (data['start_session']){
                window.location.href = 'http://127.0.0.1:8000/session/';
                sessionSocket.close()
            }
        };

        sessionSocket.onerror = function (e) {
            console.log(e)
        };

        sessionSocket.onclose = function (e) {
            console.error('Chat socket closed unexpectedly', e);
        };

    $(document).on('click', '#choice', function () {
        var chosenTutor = $(this).parents('tr').attr('id');
        sessionSocket.send(JSON.stringify({
            'chosenTutor': chosenTutor
        }));
    })
    if (!sessionSocket){
        console.log('here')
        function redirect() {
    setTimeout(function () {
        window.location.href = 'http://127.0.0.1:8000';
    }, 10000);
}

    }

    </script>


{% endblock %}